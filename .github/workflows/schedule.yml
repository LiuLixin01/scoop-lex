name: Daily Scoop Excavator

on:
  schedule:
    # 每天北京时间早上 8 点运行 (UTC 0:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # 允许手动点按钮运行

jobs:
  excavator:
    name: Excavate
    runs-on: windows-latest
    
    permissions:
      contents: write # 必须赋予写入权限

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Scoop Environment
        run: |
          # 1. 安装 Scoop
          Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
          # 2. 安装 git (scoop-checkver 不需要单独安装，它是内置的)
          scoop install git

      - name: Run Crawler (PowerShell)
        shell: powershell
        run: |
          # === 修复 1: 强制开启 TLS 1.2 (解决 QQ 音乐连接中断问题) ===
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          
          # === 核心配置区 ===
          # 修复 2: 设置 UserAgent 伪装成浏览器
          $UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          # 获取所有 json 文件
          $manifests = Get-ChildItem "bucket/*.json"
          $updatedCount = 0

          foreach ($manifest in $manifests) {
              Write-Host "Analyzing: $($manifest.BaseName)..." -NoNewline
              
              try {
                  # === 路径修正 ===
                  # 指向 Scoop 自带的 checkver 脚本
                  $checkverScript = "$env:USERPROFILE\scoop\apps\scoop\current\bin\checkver.ps1"
                  
                  # 调用 checkver
                  . $checkverScript -Dir "bucket" -App $manifest.BaseName -u
                  
                  # 检查文件是否真的变了
                  $gitStatus = git status --porcelain $manifest.FullName
                  if ($gitStatus) {
                      Write-Host " [UPDATED!]" -ForegroundColor Green
                      $updatedCount++
                  } else {
                      Write-Host " [No Change]" -ForegroundColor Gray
                  }
              } catch {
                  Write-Host " [ERROR]" -ForegroundColor Red
                  Write-Host $_.Exception.Message
              }
          }
          
          Write-Host "Total apps updated today: $updatedCount"

      - name: Commit & Push
        run: |
          git config --global user.name "Scoop Excavator"
          git config --global user.email "excavator@users.noreply.github.com"
          
          if (git status --porcelain) {
            git add bucket/*.json
            git commit -m "Auto-update: Found new versions"
            git push
          } else {
            Write-Host "No updates found today."
          }
