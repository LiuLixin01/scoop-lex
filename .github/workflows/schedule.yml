name: Daily Scoop Excavator

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 8 ç‚¹è¿è¡Œ (UTC 0:00)
    - cron: '0 0 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹æŒ‰é’®è¿è¡Œ

jobs:
  excavator:
    name: Excavate
    runs-on: windows-latest
    
    permissions:
      contents: write # å¿…é¡»èµ‹äºˆå†™å…¥æƒé™

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Initialize Scoop Environment
        run: |
          # 1. å®‰è£… Scoop
          Invoke-Expression (New-Object System.Net.WebClient).DownloadString('https://get.scoop.sh')
          # 2. å®‰è£… git (scoop-checkver æ˜¯å†…ç½®çš„)
          scoop install git

      # === ğŸ” æ ¸å¿ƒè°ƒè¯•æ­¥éª¤ (æ–°å¢) ===
      # è¿™ä¸€æ­¥ä¼šæ‰“å°å‡ºç›®æ ‡ç½‘ç«™çš„çœŸå® HTMLï¼Œå¸®æˆ‘ä»¬çœ‹æ¸…ä¸‹è½½é“¾æ¥è—åœ¨å“ªé‡Œ
      - name: Debug - Inspect HTML
        shell: powershell
        run: |
          # å¼ºåˆ¶å¼€å¯ TLS 1.2
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          # å®šä¹‰æˆ‘ä»¬è¦è¯Šæ–­çš„ URL
          $targets = @(
            "https://www.doubao.com/download/desktop/win",
            "https://y.qq.com/download/download.html"
          )

          foreach ($url in $targets) {
              Write-Host "`n----- DEBUGGING: $url -----" -ForegroundColor Cyan
              try {
                  # æ¨¡æ‹Ÿçˆ¬è™«æŠ“å–
                  $content = (Invoke-WebRequest -Uri $url -UserAgent $UserAgent -UseBasicParsing).Content
                  
                  # æ‰“å°å‰ 2000 ä¸ªå­—ç¬¦ (é¿å…æ—¥å¿—å¤ªé•¿ï¼Œåªçœ‹å¤´éƒ¨ç»“æ„)
                  Write-Host $content.Substring(0, [math]::Min(2000, $content.Length))
                  
                  # é¡ºä¾¿å¸®æˆ‘æœä¸€ä¸‹æœ‰æ²¡æœ‰ .exe çš„ç—•è¿¹
                  $exeMatches = [Regex]::Matches($content, "[\w-]+\.exe")
                  if ($exeMatches.Count -gt 0) {
                      Write-Host "`n[Found potential .exe files!]" -ForegroundColor Yellow
                      foreach ($m in $exeMatches) { Write-Host $m.Value }
                  } else {
                      Write-Host "`n[WARNING] No .exe found in plain text." -ForegroundColor Yellow
                  }
              } catch {
                  Write-Host "Failed to fetch: $_" -ForegroundColor Red
              }
          }

      - name: Run Crawler (PowerShell)
        shell: powershell
        run: |
          # === ä¿®å¤: å¼ºåˆ¶å¼€å¯ TLS 1.2 ===
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          
          # === é…ç½®: æµè§ˆå™¨ä¼ªè£… ===
          $UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
          
          # è·å–æ‰€æœ‰ json æ–‡ä»¶
          $manifests = Get-ChildItem "bucket/*.json"
          $updatedCount = 0

          foreach ($manifest in $manifests) {
              Write-Host "Analyzing: $($manifest.BaseName)..." -NoNewline
              
              try {
                  # æŒ‡å‘ Scoop è‡ªå¸¦çš„ checkver è„šæœ¬
                  $checkverScript = "$env:USERPROFILE\scoop\apps\scoop\current\bin\checkver.ps1"
                  
                  # è°ƒç”¨ checkver
                  . $checkverScript -Dir "bucket" -App $manifest.BaseName -u
                  
                  # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦çœŸçš„å˜äº†
                  $gitStatus = git status --porcelain $manifest.FullName
                  if ($gitStatus) {
                      Write-Host " [UPDATED!]" -ForegroundColor Green
                      $updatedCount++
                  } else {
                      Write-Host " [No Change]" -ForegroundColor Gray
                  }
              } catch {
                  # æ³¨æ„ï¼šè¿™é‡Œçš„ ERROR é€šå¸¸æ˜¯è„šæœ¬æœ¬èº«çš„è¾“å‡ºï¼Œä¸æ˜¯å´©æºƒ
                  Write-Host " [ERROR]" -ForegroundColor Red
                  Write-Host $_.Exception.Message
              }
          }
          
          Write-Host "Total apps updated today: $updatedCount"

      - name: Commit & Push
        run: |
          git config --global user.name "Scoop Excavator"
          git config --global user.email "excavator@users.noreply.github.com"
          
          if (git status --porcelain) {
            git add bucket/*.json
            git commit -m "Auto-update: Found new versions from daily crawl"
            git push
          } else {
            Write-Host "No updates found today."
          }
